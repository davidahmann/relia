---
name: ci

"on": ["push", "pull_request"]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Check formatting
        run: |
          files=$(git ls-files "*.go")
          if [[ -z "$files" ]]; then
            exit 0
          fi
          fmt_files=$(gofmt -l $files)
          if [[ -n "$fmt_files" ]]; then
            echo "gofmt needed:"
            echo "$fmt_files"
            exit 1
          fi

      - name: Test
        run: go test ./... -coverprofile=coverage.out

      - name: Build
        run: go build ./...

      - name: Coverage gate
        run: |
          total=$(go tool cover -func=coverage.out | awk '/^total:/{print $3}' | tr -d '%')
          TOTAL="$total" python - <<'PY'
          import os
          import sys

          raw = os.environ.get("TOTAL", "")
          try:
              total = float(raw)
          except ValueError:
              print("coverage parsing failed")
              sys.exit(1)

          if total < 85.0:
              print(f"coverage {total:.1f}% below 85%")
              sys.exit(1)

          print(f"coverage {total:.1f}%")
          PY

  docs-site:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: docs-site/package-lock.json

      - name: Install
        working-directory: docs-site
        run: npm ci

      - name: Lint
        working-directory: docs-site
        run: npm run lint

      - name: Build
        working-directory: docs-site
        run: npm run build
